# render.yaml — Agricore Production Deploy (Supabase + Render + Upstash)
services:
  # ============ MAIN DJANGO API ============
  - type: web
    name: agricore-api
    env: python
    region: singapore                  # Same region as your Supabase & Upstash = fastest
    plan: starter                       # Change to starter_plus or pro later if needed
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      python manage.py collectstatic --noinput --clear || true
      python manage.py migrate --noinput
    startCommand: gunicorn agricore_project.wsgi:application --workers 4 --worker-class sync --timeout 300 --max-requests 1000 --max-requests-jitter 100
    autoDeploy: true

    envVars:
      # Django
      DEBUG: "False"
      SECRET_KEY: "django-insecure-change-this-to-a-real-80-char-secret-1234567890"  # ← CHANGE THIS!
      ALLOWED_HOSTS: "*.onrender.com,localhost,127.0.0.1"

      # Supabase Database (direct connection string – works perfectly)
      DATABASE_URL: "***REMOVED***postgres.sfpnywjgxygbalfbqpod:Matthew!$2005@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"

      # Supabase general
      SUPABASE_URL: "https://sfpnywjgxygbalfbqpod.supabase.co"
      SUPABASE_ANON_KEY: "sb_publishable_VCnL9O66_-XUCrP7VyNi8A_I7-PgeQA"
      SUPABASE_SERVICE_ROLE_KEY: "sb_secret_L_XvndknS6QOwc6eLpwI3Q_8vpnvK_7"

      # Groq AI
      GROQ_API_KEY: "***REMOVED***NN6VnZWgqUH3H36nj5HqWGdyb3FYrNXmOElLy6ad7PTZBbMgAwdX"

      # Upstash Redis (Channels + Celery) — paste your full ***REMOVED*** URL here
      REDIS_URL: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"
      CELERY_BROKER_URL: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"
      CELERY_RESULT_BACKEND: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"

      # Channels
      CHANNEL_LAYERS_BACKEND: "channels_redis.core.RedisChannelLayer"

      # CORS (safe for production)
      CORS_ALLOW_ALL_ORIGINS: "False"
      CORS_ALLOWED_ORIGINS: "https://your-frontend-domain.vercel.app,https://agricore-web.onrender.com,http://localhost:3000"

  # ============ CELERY WORKER (AI tasks, receipt parsing, predictions) ============
  - type: worker
    name: agricore-celery
    env: python
    region: singapore
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A agricore_project worker --loglevel=info --concurrency=4
    autoDeploy: true

    envVars:
      DATABASE_URL: "***REMOVED***postgres.sfpnywjgxygbalfbqpod:Matthew!$2005@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"
      SUPABASE_URL: "https://sfpnywjgxygbalfbqpod.supabase.co"
      SUPABASE_SERVICE_ROLE_KEY: "sb_secret_L_XvndknS6QOwc6eLpwI3Q_8vpnvK_7"
      GROQ_API_KEY: "***REMOVED***NN6VnZWgqUH3H36nj5HqWGdyb3FYrNXmOElLy6ad7PTZBbMgAwdX"
      REDIS_URL: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"
      CELERY_BROKER_URL: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"
      CELERY_RESULT_BACKEND: "***REMOVED***default:YOUR_FULL_UPSTASH_PASSWORD_HERE@comic-piranha-46027.upstash.io:6379"