# render.yaml â€” Agricore Production Deploy (Supabase + Render + Upstash)
services:
  # ============ MAIN DJANGO API ============
  - type: web
    name: agricore-api
    env: python
    region: singapore
    plan: starter
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      python manage.py collectstatic --noinput --clear || true
      python manage.py migrate --noinput
    startCommand: gunicorn agricore_project.wsgi:application --workers 4 --worker-class sync --timeout 300 --max-requests 1000 --max-requests-jitter 100
    autoDeploy: true

    envVars:
      # Django
      DEBUG: "False"
      SECRET_KEY: "REPLACE_WITH_REAL_SECRET_KEY"
      ALLOWED_HOSTS: "*.onrender.com,localhost,127.0.0.1"

      # Supabase Database
      DATABASE_URL: "REPLACE_WITH_REAL_DB_URL"

      # Supabase general
      SUPABASE_URL: "REPLACE_WITH_REAL_SUPABASE_URL"
      SUPABASE_ANON_KEY: "REPLACE_WITH_REAL_ANON_KEY"
      SUPABASE_SERVICE_ROLE_KEY: "REPLACE_WITH_REAL_SERVICE_ROLE_KEY"

      # Groq AI
      GROQ_API_KEY: "REPLACE_WITH_REAL_GROQ_KEY"

      # Upstash Redis (Channels + Celery)
      REDIS_URL: "REPLACE_WITH_REAL_REDIS_URL"
      CELERY_BROKER_URL: "REPLACE_WITH_REAL_REDIS_URL"
      CELERY_RESULT_BACKEND: "REPLACE_WITH_REAL_REDIS_URL"

      # Channels
      CHANNEL_LAYERS_BACKEND: "channels_redis.core.RedisChannelLayer"

      # CORS (safe for production)
      CORS_ALLOW_ALL_ORIGINS: "False"
      CORS_ALLOWED_ORIGINS: "https://your-frontend-domain.vercel.app,https://agricore-web.onrender.com,http://localhost:3000"

  # ============ CELERY WORKER (AI tasks, receipt parsing, predictions) ============
  - type: worker
    name: agricore-celery
    env: python
    region: singapore
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A agricore_project worker --loglevel=info --concurrency=4
    autoDeploy: true

    envVars:
      DATABASE_URL: "REPLACE_WITH_REAL_DB_URL"
      SUPABASE_URL: "REPLACE_WITH_REAL_SUPABASE_URL"
      SUPABASE_SERVICE_ROLE_KEY: "REPLACE_WITH_REAL_SERVICE_ROLE_KEY"
      GROQ_API_KEY: "REPLACE_WITH_REAL_GROQ_KEY"
      REDIS_URL: "REPLACE_WITH_REAL_REDIS_URL"
      CELERY_BROKER_URL: "REPLACE_WITH_REAL_REDIS_URL"
      CELERY_RESULT_BACKEND: "REPLACE_WITH_REAL_REDIS_URL"